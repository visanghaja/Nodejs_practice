<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/main.css">
</head>
<body class="grey-bg">

    <%- include('nav.ejs') %>
    <!-- ì´ë ‡ê²Œ í•˜ë©´ nav.ejs ì— ìˆëŠ” ë‚´ìš©ì´ ë³µì‚¬ë¨ -->

    <form action="/search" method="POST">
        <input name="titlename" class="search">
        <button type="submit" class="search-send">ê²€ìƒ‰</button>
    </form>

    <!-- <script>
        from ì•ˆì“°ê³  í•˜ê¸°!
        document.querySelector('.search-send').addEventListener('click', function() {
            let ì…ë ¥í•œê±° = document.querySelector('.search').value
            location.href = '/search?val=' + ì…ë ¥í•œê±° // ì´ URL ë¡œ get ìš”ì²­ ë‚ ë ¤ì£¼ì„¸ìš”
        })
    </script> -->

    <div class="white-bg">
        <% for (let i = 0; i < posts.length; i++){ %>
            <div class="list-box">
                <h4>
                    <a href="/detail/<%= posts[i]._id %>"><%= posts[i].title %></a>
                </h4>
                <a href="/edit/<%= posts[i]._id %>">âœï¸</a>
                
                <% if (posts[i].user && user && posts[i].user.toString() === user.toString()) { %>
                    <span class="delete" data-id="<%= posts[i]._id %>">ğŸ—‘ï¸</span>
                <% } %>
                
                <p><%= posts[i].content %></p>
            </div>
        <% } %>
    </div>

    <div class="page-button">
        <button>
            <a href="/list/1">1</a>
        </button>
        <button>
            <a href="/list/2">2</a>
        </button>
        <button>
            <a href="/list/3">3</a>
        </button>
    </div>

    <a href="/list/next/<%= posts[posts.length-1]._id %>">ë‹¤ìŒ</a>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>

        // axios.get('/URL').then((r)=>{console.log(r)

        // }).catch(()=>{
        //     // ì—ëŸ¬ì‹œ ì‹¤í–‰í•  ì½”ë“œ
        // })

        // document.querySelectorAll('.delete').forEach((e1) => {
        //     e1.addEventListener('click', function(e) {
        //         fetch('/delete?docid=' + e1.dataset.id, {
        //             method : "DELETE"
        //         })
        //         .then((r)=>r.text())
        //         .then((r)=>{})
        //         .then((r)=>{ e.target.parentElement.style.display = 'none' } ) // list boxë¥¼ ì•ˆë³´ì´ë„ë¡
        //         // ì„œë²„ì— ë³´ë‚´ëŠ”ê²Œ object ì´ë©´ r.json()
        //         // ì—¬ê¸°ì„œ rì—ëŠ” ì‚­ì œì™„ë£Œê°€ ë“¤ì–´ê° (ì„œë²„ì— ìˆëŠ”)
        //         // í¬ë¡¬ consoleì— ë‚˜íƒ€ë‚¨
        //         // ì—¬ê¸°ë‹¤ê°€ ëª¨ë‹¬ì°½ ë§Œë“¤ ìˆ˜ë„ ìˆìŒ (html)
                
        //     })
        // })

            document.querySelectorAll('.delete').forEach((e1) => {
                e1.addEventListener('click', function (e) {
                fetch('/delete?docid=' + e1.dataset.id, {
                    method: 'DELETE'
                })
                .then((r) => {
                    if (!r.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
                    return r.text();
                })
                .then((result) => {
                    if (result === 'ì‚­ì œì™„ë£Œ') {
                        e.target.parentElement.style.display = 'none';
                    } else {
                        alert('ì‚­ì œ ì‹¤íŒ¨: ' + result);
                    }
                })
                .catch((err) => {
                    alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    console.error(err);
                });
            });
        });
    </script>

    <script>
        let eventSource = new EventSource('stream/list')
        eventSource.addEventListener('msg', function(e){ // ì„œë²„ê°€ msg ì´ë¦„ìœ¼ë¡œ ë°ì´í„° ë³´ë‚´ë©´ ì½œë°±í•¨ìˆ˜ ì•ˆì— ì½”ë“œê°€ ì‹¤í–‰ë¨!
            console.log(e.data) // ì„œë²„ê°€ ë³´ë‚¸ ì½”ë“œëŠ” e.data ì•ˆì— ë“¤ì–´ìˆìŒ!
            let ê°€ì ¸ì˜¨ê±° = JSON.parse(e.data) // JSON í˜•íƒœì¸ê±° object í˜•íƒœë¡œ ë°”ê¿”ì£¼ê¸°
            document.querySelector('.white-bg').insertAdjacentHTML('afterbegin', `<div class = "list-box"><h4>${ê°€ì ¸ì˜¨ê±°.title}</h4></div>`)
        })
    </script>
</body>
</html>